#!/bin/bash
set -e
# change dir to script location
cd "${0%/*}"

# config
MAX_R=10

# default arguments
SEED=1
DATASET="ECG200"
TIMEOUT="7200"
CUTOFF="180"
METHOD="mo"
ALGO="all"
WRAPPER="./wrapper"

while [[ $# -gt 0 ]]; do
case "$1" in
    --seed|-s)
        SEED="$2"
        shift; shift
        ;;
    --dataset|--data|-d)
        DATASET="$2"
        shift; shift
        ;;
    --timeout|--time|-t)
        TIMEOUT="$2"
        shift; shift
        ;;
    --cutoff-time|--cutoff|-c)
        CUTOFF="$2"
        shift; shift
        ;;
    --method|-m)
        METHOD="$2"
        shift; shift
        ;;
    --algorithm|--algo)
        ALGO="$2"
        shift; shift
        ;;
    --instance-file|--inst|-i)
        INSTANCE_FILE="$2"
        shift; shift
        ;;
    *)
        shift
        ;;
esac
done

SMAC="python ../smac/smac \
        --verbose_level DEBUG \
        --maxR ${MAX_R}"
PARAMILS="../paramils/paramils \
        --validation false \
        --MO true \
        --rungroup run_${SEED} \
        --log-details true \
        --max-runs ${MAX_R}"

if [[ $METHOD == "so" ]]; then
    CONFIGURATOR="${SMAC}"
    WRAPPER="./wrapper --MO false"
else
    CONFIGURATOR="${PARAMILS}"
fi

CONDITION="${DATASET}/${METHOD}-${ALGO}"
CONF_OUT="output/configurator/${CONDITION}"
mkdir -p "${CONF_OUT}"

# Start the configurator
${CONFIGURATOR} --scenario "scenario.txt" \
                --algo "$WRAPPER" \
                --seed "$SEED" \
                --instance-file "$INSTANCE_FILE" \
                --wallclock-limit "$TIMEOUT" \
                --cutoff-time "$CUTOFF" \
                --deterministic 0 \
                --run-obj "quality" \
                --overall-obj "mean" \
                --execdir "../experiments/" \
                --output-dir "../experiments/${CONF_OUT}" \
                --param-file "pcs/${METHOD}-${ALGO}.pcs"

# make sure the configs file is populated
if [[ $METHOD == "so" ]]; then
    CONFIGS="${CONF_OUT}/run_${SEED}/configs${SEED}.txt"
    ../smac/configs.py "${CONF_OUT}/run_${SEED}/traj.json" > "${CONFIGS}"
    mv "${CONF_OUT}/run_${SEED}.OLD/log" "${CONF_OUT}/run_${SEED}"
    rm -rf ${CONF_OUT}/run_${SEED}.OLD
fi
