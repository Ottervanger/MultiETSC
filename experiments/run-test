#!/bin/bash
set -e
# change dir to script location
cd "${0%/*}"

UCR="/vol/share/groups/liacs/scratch/UCR/"
SEED=0

# collect pareto fronts based on validation
./pareto.py

echo "Starting test evaluations"
mkdir -p "output/test/"

for CONFIGS in output/pareto/*.txt; do
    ar=($(tr "/-" " " <<<$CONFIGS))
    DATASET=${ar[2]}
    CONDITION=$(IFS=-; echo "${ar[*]:2:3}")
    TEST_OUT="output/test/${CONDITION}.csv"
    # computed file locations
    ABS_PATH_TRAIN=$UCR$DATASET"/"$DATASET"_TRAIN.tsv"
    ABS_PATH_TEST=$UCR$DATASET"/"$DATASET"_TEST.tsv"
    DATA="${ABS_PATH_TRAIN}:${ABS_PATH_TRAIN}"
    >"${TEST_OUT}"
    while read CONF; do
        (echo $(./wrapper --MO "true" $DATA 0 9999 0 $SEED $CONF -np 1)", $CONF" | tee -a "$TEST_OUT") &
        sleep 0.1
        while [[ $(grep -oP 'running \K[0-9]*' /proc/stat) -ge $(grep -c 'processor' /proc/cpuinfo) ]]; do
            sleep 1
        done
    done<"${CONFIGS}"
done
# wait for parallel jobs to finish
wait
