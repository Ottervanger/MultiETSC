#!/bin/bash
set -e
# run from "experiments" dir
cd "${0%/*}/.."
DATASETS=(Coffee CBF ECG200 TwoPatterns Wafer Fish GestureMidAirD3 OliveOil Phoneme)
ALGS=(all all fixed ects edsc ecdire srcf relclass teaser ecec earliest)
METHODS=(mo so mo mo mo mo mo mo mo mo mo)
CONFJOBS=()
TESTJOBS=()
REPS=25
export UCR_ROOT="/scratch/ottervanger/UCR/"
export PARTITION="graceADA"
export EXCLUDE="ethnode[23]"
export GLOBAL_SEED=0
START=$GLOBAL_SEED

for DATASET in ${DATASETS[*]}; do
    if ! python util/validationsplitter.py --folds=5  --seed=$GLOBAL_SEED --reps=$REPS "${UCR_ROOT}${DATASET}/${DATASET}_TRAIN.tsv" &> /dev/null; then
        printf "%20s: \e[31mFailed to split dataset.\e[0m\n" $DATASET
        continue
    fi
    for i in ${!METHODS[*]}; do
        METHOD=${METHODS[i]}
        ALG=${ALGS[i]}
        if [ ! "$1" == "noconf" ]; then
            eval mkdir -p "output/configurator/${DATASET}/${METHOD}-${ALG}/run_{${START}..$((REPS - 1 - START))}"
            # configuration and validation
            CONFJOB=$( sbatch --parsable --hold --array=${START}-$((REPS - 1 - START)) --nice=3 \
                              --partition=$PARTITION --exclude=$EXCLUDE \
                              --output=output/configurator/${DATASET}/${METHOD}-${ALG}/run_%a/log \
                              slurm/run-configurator-batch --dataset $DATASET --method $METHOD --algorithm $ALG )
            CONFJOBS+=($CONFJOB)
            DEP="-d afterok:${CONFJOB}"
        fi
        # pareto extraction and test evaluation
        mkdir -p output/test/${DATASET}/${METHOD}-${ALG}
        TESTJOB=$( sbatch --parsable $DEP --kill-on-invalid-dep=yes --nice=1 \
                          --partition=$PARTITION --exclude=$EXCLUDE \
                          --output=output/test/${DATASET}/${METHOD}-${ALG}/log \
                          slurm/run-test-master $DATASET $METHOD $ALG )
        [ -z "$CONFJOB" ] || scontrol release ${CONFJOB}
        TESTJOBS+=($TESTJOB)
    done
    printf "%20s: Jobs submitted.\n" $DATASET
done
printf "Submitted batch %3d jobs for configuration\n" "${#CONFJOBS[@]}"
printf "Submitted batch %3d jobs for test evaluation\n" "${#TESTJOBS[@]}"