#!/bin/bash
set -e
# change dir to script location
cd "${0%/*}"

# config
VALIDATION="--folds=5"
UCR="/vol/share/groups/liacs/scratch/UCR/"

# default arguments
SEED=1
DATASET="ECG200"
TIMEOUT="3600"
METHOD="mo"
CONFIGURATOR="../paramils/paramils"

# TODO
# Everything is identified based on the seed. This is not a proper id. Ids
# should be generated by hashing the config. Intermediary results should be 
# saved and retrived based on this id to prevent redundant computation.

while [[ $# -gt 0 ]]; do
case "$1" in
    --seed|-s)
        SEED="$2"
        shift; shift
        ;;
    --dataset|--data|-d)
        DATASET="$2"
        shift; shift
        ;;
    --timeout|--time|-t)
        TIMEOUT="$2"
        shift; shift
        ;;
    --SO)
        METHOD="so"
        CONFIGURATOR="python ../smac/smac"
        shift
        ;;
    *)
        shift
        ;;
esac
done

# computed file locations
ABS_PATH_TRAIN=$UCR$DATASET"/"$DATASET"_TRAIN.tsv"
ABS_PATH_TEST=$UCR$DATASET"/"$DATASET"_TEST.tsv"

# running initialization scripts for each algorithms needing it
for alg in {'RelClass',}; do
    timeout 600 "../${alg}/init"
done

# Produce train-validate split from training data
INSTANCE=$(python ../util/validationsplitter.py "$VALIDATION" --seed=$SEED "$ABS_PATH_TRAIN")

# Start the configurator
${CONFIGURATOR} --scenario "${METHOD}scenario.txt" \
                --seed "$SEED" \
                --instance_file "$INSTANCE" \
                --tuner-timeout "$TIMEOUT" 

# note that we use mo validation regardless of the optimization method
configs=$(realpath "output/${METHOD}/configs${SEED}.txt")
validation_out=$(realpath "output/results/${DATASET}-${METHOD}-${TIMEOUT}-${SEED}.csv")

if [[ $METHOD == "so" ]]; then
    rm -rf output/*.OLD
    ../smac/configs.py "output/run_${SEED}/traj.json" > "${configs}"
fi

echo "Starting off-line validation"
>"$validation_out"
while read conf; do
    echo $(./wrapper --timeout 9999 --MO "true" "$ABS_PATH_TRAIN" "$ABS_PATH_TEST" $conf)", $conf" | tee -a "$validation_out"
done<"${configs}"

../RelClass/matlab-runner exit

